---
import ImgUsu from "./ImgUsu.jsx";
import {
    db,
    Gusta,
    Escucha,
    Cancion,
    Album,
    Artista,
    Produce,
    Compone,
    Productor,
} from "astro:db";
import { eq } from "astro:db";
import { parse } from "cookie";

const cookie_acceso = parse(Astro.request.headers.get("cookie") || "");
const cod_usu = parseInt(cookie_acceso.codigo_usu);
const haentradoencuenta = cookie_acceso.auth === "true";

export interface Usuario {
    cod_usuario: number;
    nombre_usuario: string;
    nombre: string;
    apellidos: string;
    contraseña: string;
    correo_electronico: string;
    direccion_usu: string;
    telefono_usu: string;
    tipo_usu: boolean;
    img_usu: string;
    fecha_nacimiento: Date;
    fecha_registro: Date;
}

interface Props {
    usuario_accedido_info: Usuario;
}

const canciones_gustadas = await db
    .select({
        id: Cancion.cod_cancion,
        titulo: Cancion.titulo,
        reproducciones: Cancion.num_reproducciones,
    })
    .from(Cancion)
    .innerJoin(Escucha, eq(Cancion.cod_cancion, Escucha.cod_cancion))
    .where(eq(Escucha.cod_usuario, cod_usu));

const { usuario_accedido_info } = Astro.props as Props;
---

<div class="flex flex-col items-start mb-6">
    <div class="flex items-center space-x-4 mb-6">
        <ImgUsu
            client:load
            ruta={usuario_accedido_info.img_usu}
            alt="Imagen de perfil"
        />
        <div>
            <h1 class="text-2xl font-bold">
                {usuario_accedido_info.nombre_usuario}
            </h1>
            <p class="text-lg">
                {usuario_accedido_info.nombre}
                {usuario_accedido_info.apellidos}
            </p>
        </div>
    </div>
    <div class="grid grid-cols-2 gap-6 w-full">
        <div>
            <p class="font-semibold">Correo electrónico:</p>
            <p>{usuario_accedido_info.correo_electronico}</p>
        </div>
        <div>
            <p class="font-semibold">Fecha de nacimiento:</p>
            <p>
                {
                    usuario_accedido_info.fecha_nacimiento.toLocaleDateString(
                        "es-ES",
                    )
                }
            </p>
        </div>
        <div>
            <p class="font-semibold">Dirección:</p>
            <p>{usuario_accedido_info.direccion_usu}</p>
        </div>
        <div>
            <p class="font-semibold">Teléfono:</p>
            <p>{usuario_accedido_info.telefono_usu}</p>
        </div>
    </div>
</div>

<div class="flex flex-row items-start mb-6 space-x-6">
    <div>
        <h2 class="text-xl font-bold mb-2">Canciones favoritas</h2>
        <ul>
            {
                canciones_gustadas.map((cancion) => (
                    <li class="mb-1">
                        {cancion.titulo} -{" "}
                        {cancion.reproducciones.toLocaleString()} reproducciones
                    </li>
                ))
            }
        </ul>
    </div>
    <div>
        <h2 class="text-xl font-bold mb-2">Artistas favoritos</h2>
    </div>
    <div>
        <h2 class="text-xl font-bold mb-2">Álbumes favoritos</h2>
    </div>
</div>
