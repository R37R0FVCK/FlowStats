---
// filepath: c:\Users\angel\Desktop\TFG-2DAM\FlowStats\src\pages\Registro.astro

import Layout from "../layouts/Layout.astro";
import { db, Usuario } from "astro:db";
import {
    esMayorDe16,
    ContraseñaValida,
} from "../scripts/VerificacionDatos/VerificacionDatos.js";

const fecha_actual = new Date();
let errores = [];

const correos_registrados = await db
    .select({
        correo_electronico: Usuario.correo_electronico,
    })
    .from(Usuario);

const nombres_usu_registrados = await db
    .select({
        nombre_usuario: Usuario.nombre_usuario,
    })
    .from(Usuario);

if (Astro.request.method === "POST") {
    const datosformulario = await Astro.request.formData();
    const nombre_usuario = datosformulario.get("nombre_usuario");
    const nombre = datosformulario.get("nombre");
    const apellidos = datosformulario.get("apellidos");
    const contraseña = datosformulario.get("contraseña");
    const correo_electronico = datosformulario.get("correo_electronico");
    const direccion_usu = datosformulario.get("direccion_usu");
    const telefono_usu = datosformulario.get("telefono_usu");
    const fechanacimientotexto = datosformulario.get("fecha_nacimiento");
    const tipousuariotexto = datosformulario.get("tipo_usu");

    if (
        typeof nombre_usuario === "string" &&
        typeof nombre === "string" &&
        typeof apellidos === "string" &&
        typeof contraseña === "string" &&
        typeof correo_electronico === "string" &&
        typeof direccion_usu === "string" &&
        typeof telefono_usu === "string" &&
        typeof fechanacimientotexto === "string" &&
        typeof tipousuariotexto === "string"
    ) {
        const fecha_nacimiento = new Date(fechanacimientotexto);

        // Validar si el usuario es mayor de 16 años
        if (!esMayorDe16(fecha_nacimiento)) {
            errores.push("Debes tener 16 años o más para poder registrarte.");
        }

        // Validar si la contraseña es válida
        const erroresContraseña = ContraseñaValida(contraseña);
        errores = errores.concat(erroresContraseña);

        if (errores.length === 0) {
            const tipo_usu = tipousuariotexto === "true";
            const fecha_registro = fecha_actual;

            const img_usu =
                "https://imagedelivery.net/DX6aCRCKOB_y-l4MZVDT9w/67b1b1e8-6955-4edb-5238-7578e8090f00/public";

            await db.insert(Usuario).values({
                nombre_usuario,
                nombre,
                apellidos,
                contraseña,
                correo_electronico,
                direccion_usu,
                telefono_usu,
                tipo_usu,
                img_usu,
                fecha_nacimiento,
                fecha_registro,
            });
        }
    }
}
---
<Layout title="Registro">
    <div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6 text-center">Registro de Usuario</h2>

        <!-- Listado de errores -->
        <ul id="errores" class="text-red-500 mb-4 list-disc pl-5 hidden"></ul>

        <form method="POST" class="flex flex-col space-y-4" id="registro-form">
            <!-- Campos del formulario -->
            <label class="block">
                <span class="text-gray-700">Nombre de Usuario:</span>
                <input
                    type="text"
                    name="nombre_usuario"
                    id="nombre_usuario"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Nombre:</span>
                <input
                    type="text"
                    name="nombre"
                    id="nombre"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Apellidos:</span>
                <input
                    type="text"
                    name="apellidos"
                    id="apellidos"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Contraseña:</span>
                <input
                    type="password"
                    name="contraseña"
                    id="contraseña"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Correo Electrónico:</span>
                <input
                    type="email"
                    name="correo_electronico"
                    id="correo_electronico"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Dirección:</span>
                <input
                    type="text"
                    name="direccion_usu"
                    id="direccion_usu"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Teléfono:</span>
                <input
                    type="text"
                    name="telefono_usu"
                    id="telefono_usu"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Fecha de Nacimiento:</span>
                <input
                    type="date"
                    name="fecha_nacimiento"
                    id="fecha_nacimiento"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Tipo de Usuario:</span>
                <select
                    name="tipo_usu"
                    id="tipo_usu"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                >
                    <option value="true">Administrador</option>
                    <option value="false">Usuario Normal</option>
                </select>
            </label>

            <button
                type="submit"
                class="w-full bg-indigo-500 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                Registrar
            </button>
        </form>
    </div>
        <!-- Inyectar los datos directamente en el script -->
    <script set:html={`
        const correosRegistrados = ${JSON.stringify(correos_registrados.map(c => c.correo_electronico))};
    `}></script>
</Layout>




<script>
    import {
        esMayorDe16,
        ContraseñaValida,
    } from "../scripts/VerificacionDatos/VerificacionDatos.js";

    document.addEventListener("DOMContentLoaded", function () {
        const registroForm = document.getElementById("registro-form");
        const erroresList = document.getElementById("errores");

        if (registroForm) {
            registroForm.addEventListener("submit", function (event) {
                const errores = [];
                const correoElectronicoInput = document.getElementById("correo_electronico");
                const correoElectronico = correoElectronicoInput?.value || "";
                const contraseñaInput = document.getElementById("contraseña");
                const contraseña = contraseñaInput?.value || "";
                const fechaNacimientoInput = document.getElementById("fecha_nacimiento");
                const fechaNacimientoTexto = fechaNacimientoInput?.value || "";

                // Validar si el correo electrónico ya está registrado
                if (correosRegistrados.includes(correoElectronico)) {
                    errores.push("El correo electrónico ya está registrado.");
                }

                // Validar si la contraseña es válida
                const erroresContraseña = ContraseñaValida(contraseña);
                errores.push(...erroresContraseña);

                // Validar si el usuario es mayor de 16 años
                if (fechaNacimientoTexto) {
                    const fechaNacimiento = new Date(fechaNacimientoTexto);
                    if (!esMayorDe16(fechaNacimiento)) {
                        errores.push("Debes tener 16 años o más para poder registrarte.");
                    }
                } else {
                    errores.push("La fecha de nacimiento es obligatoria.");
                }

                // Mostrar errores si existen
                if (errores.length > 0) {
                    event.preventDefault();
                    erroresList.innerHTML = errores.map((error) => `<li>${error}</li>`).join("");
                    erroresList.classList.remove("hidden");
                } else {
                    erroresList.classList.add("hidden");
                }
            });
        }
    });
</script>