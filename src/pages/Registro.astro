---
import Layout from "../layouts/Layout.astro";
import { db, User } from "astro:db";

if (Astro.request.method === "POST") {
    // Parse form data
    const formData = await Astro.request.formData();
    const nombre = formData.get("nombre");
    const contraseña = formData.get("contraseña");
    const apellidos = formData.get("apellidos");
    const correo = formData.get("correo");
    const direccion = formData.get("direccion");
    const fecha_nacimiento = formData.get("fecha_nacimiento");
    const tipo_usuario = formData.get("tipo_usuario");
    const telefono = formData.get("telefono");

    if (
        typeof nombre === "string" &&
        typeof contraseña === "string" &&
        typeof apellidos === "string" &&
        typeof correo === "string" &&
        typeof direccion === "string" &&
        typeof fecha_nacimiento === "string" &&
        typeof tipo_usuario === "string" &&
        typeof telefono === "string"
    ) {
        // Insert form data into the User table
        await db.insert(User).values({
            nombre,
            contraseña,
            apellidos,
            correo,
            direccion,
            fecha_nacimiento,
            tipo_usuario,
            telefono,
        });
    }
}

// Render the new list of users on each request
const users = await db.select().from(User);
---

<Layout title="Registro">
    <div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6 text-center">Registro de Usuario</h2>
        <form method="POST" class="flex flex-col space-y-4">
            <label class="block">
                <span class="text-gray-700">Nombre:</span>
                <input
                    type="text"
                    name="nombre"
                    id="nombre"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Contraseña:</span>
                <input
                    type="password"
                    name="contraseña"
                    id="contraseña"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Apellidos:</span>
                <input
                    type="text"
                    name="apellidos"
                    id="apellidos"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Correo:</span>
                <input
                    type="email"
                    name="correo"
                    id="correo"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Dirección:</span>
                <input
                    type="text"
                    name="direccion"
                    id="direccion"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Fecha de Nacimiento:</span>
                <input
                    type="date"
                    name="fecha_nacimiento"
                    id="fecha_nacimiento"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Tipo de Usuario:</span>
                <input
                    type="text"
                    name="tipo_usuario"
                    id="tipo_usuario"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Teléfono:</span>
                <input
                    type="text"
                    name="telefono"
                    id="telefono"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <button
                type="submit"
                class="w-full bg-indigo-500 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >Registrar</button
            >
        </form>
        <div class="mt-10">
            <h3 class="text-xl font-bold mb-4">Usuarios Registrados</h3>
            {
                users.length === 0 ? (
                    <p class="text-gray-700">No hay usuarios registrados.</p>
                ) : (
                    <ul class="space-y-2">
                        {users.map((user) => (
                            <li class="p-4 bg-gray-100 rounded-md shadow-sm">
                                <p>
                                    <strong>Nombre:</strong> {user.nombre}
                                </p>
                                <p>
                                    <strong>Apellidos:</strong> {user.apellidos}
                                </p>
                                <p>
                                    <strong>Correo:</strong> {user.correo}
                                </p>
                                <p>
                                    <strong>Dirección:</strong> {user.direccion}
                                </p>
                                <p>
                                    <strong>Fecha de Nacimiento:</strong>{" "}
                                    {user.fecha_nacimiento}
                                </p>
                                <p>
                                    <strong>Tipo de Usuario:</strong>{" "}
                                    {user.tipo_usuario}
                                </p>
                                <p>
                                    <strong>Teléfono:</strong> {user.telefono}
                                </p>
                            </li>
                        ))}
                    </ul>
                )
            }
        </div>
    </div>
</Layout>
