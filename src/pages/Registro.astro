---
import { date } from "astro:schema";
import Layout from "../layouts/Layout.astro";
import { db, Usuario } from "astro:db";

const fecha_actual = new Date();
if (Astro.request.method === "POST") {
    // Parse form data
    const formData = await Astro.request.formData();
    const nombre_usuario = formData.get("nombre_usuario");
    const nombre = formData.get("nombre");
    const apellidos = formData.get("apellidos");
    const contraseña = formData.get("contraseña");
    const correo_electronico = formData.get("correo_electronico");
    const direccion_usu = formData.get("direccion_usu");
    const telefono_usu = formData.get("telefono_usu");
    const fechanacimientotexto = formData.get("fecha_nacimiento");
    const tipousuariotexto = formData.get("tipo_usu");

    if (
        typeof nombre_usuario === "string" &&
        typeof nombre === "string" &&
        typeof apellidos === "string" &&
        typeof contraseña === "string" &&
        typeof correo_electronico === "string" &&
        typeof direccion_usu === "string" &&
        typeof telefono_usu === "string" &&
        typeof fechanacimientotexto === "string" &&
        typeof tipousuariotexto === "string"
    ) {
        // conversiones de texto a sus tipos adecuados
        const fecha_nacimiento = new Date(fechanacimientotexto);

        const tipo_usu = tipousuariotexto === "true";
        const fecha_registro = fecha_actual;

        await db.insert(Usuario).values({
            nombre_usuario,
            nombre,
            apellidos,
            contraseña,
            correo_electronico,
            direccion_usu,
            telefono_usu,
            fecha_nacimiento,
            tipo_usu,
            fecha_registro,
        });
    }
}

// Render the new list of usuarios on each request
const usuarios = await db.select().from(Usuario);
---

<Layout title="Registro">
    <div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6 text-center">Registro de Usuario</h2>
        <form method="POST" class="flex flex-col space-y-4">
            <label class="block">
                <span class="text-gray-700">Nombre de Usuario:</span>
                <input
                    type="text"
                    name="nombre_usuario"
                    id="nombre_usuario"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Nombre:</span>
                <input
                    type="text"
                    name="nombre"
                    id="nombre"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Apellidos:</span>
                <input
                    type="text"
                    name="apellidos"
                    id="apellidos"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Contraseña:</span>
                <input
                    type="password"
                    name="contraseña"
                    id="contraseña"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Correo Electrónico:</span>
                <input
                    type="email"
                    name="correo_electronico"
                    id="correo_electronico"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Dirección:</span>
                <input
                    type="text"
                    name="direccion_usu"
                    id="direccion_usu"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Teléfono:</span>
                <input
                    type="text"
                    name="telefono_usu"
                    id="telefono_usu"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Fecha de Nacimiento:</span>
                <input
                    type="date"
                    name="fecha_nacimiento"
                    id="fecha_nacimiento"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </label>
            <label class="block">
                <span class="text-gray-700">Tipo de Usuario:</span>
                <select
                    name="tipo_usu"
                    id="tipo_usu"
                    required
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                >
                    <option value="true">Administrador</option>
                    <option value="false">Usuario Normal</option>
                </select>
            </label>

            <button
                type="submit"
                class="w-full bg-indigo-500 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >Registrar</button
            >
        </form>
        <div class="mt-10">
            <h3 class="text-xl font-bold mb-4">Usuarios Registrados</h3>
            {
                usuarios.length === 0 ? (
                    <p class="text-gray-700">No hay usuarios registrados.</p>
                ) : (
                    <ul class="space-y-2">
                        {usuarios.map((usuario) => (
                            <li class="p-4 bg-gray-100 rounded-md shadow-sm">
                                <p>
                                    <strong>Nombre de Usuario:</strong>{" "}
                                    {usuario.nombre_usuario}
                                </p>
                                <p>
                                    <strong>Nombre:</strong> {usuario.nombre}
                                </p>
                                <p>
                                    <strong>Apellidos:</strong>{" "}
                                    {usuario.apellidos}
                                </p>
                                <p>
                                    <strong>Correo Electrónico:</strong>{" "}
                                    {usuario.correo_electronico}
                                </p>
                                <p>
                                    <strong>Dirección:</strong>{" "}
                                    {usuario.direccion_usu}
                                </p>
                                <p>
                                    <strong>Teléfono:</strong>{" "}
                                    {usuario.telefono_usu}
                                </p>
                                <p>
                                    <strong>Fecha de Nacimiento:</strong>{" "}
                                    {usuario.fecha_nacimiento}
                                </p>
                                <p>
                                    <strong>Tipo de Usuario:</strong>{" "}
                                    {usuario.tipo_usu
                                        ? "Administrador"
                                        : "Usuario Normal"}
                                </p>
                                <p>
                                    <strong>Fecha de Registro:</strong>{" "}
                                    {usuario.fecha_registro}
                                </p>
                            </li>
                        ))}
                    </ul>
                )
            }
        </div>
    </div>
</Layout>
